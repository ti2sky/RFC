# TiTravel RFC

> 作者：@jyz0309 @tszkitlo40 @fgksgf @kezhenxu94

## 项目介绍

扩展TiDB能力，实现对负载的一键录制与回放，从而帮助用户便捷地进行场景仿真和压力测试；同时对TiDB的可观测性进行增强，便于更好地监测整个过程。

## 背景 & 动机

当遇到一些大促活动时，为了保障数据库系统的稳定性，客户可能需要提前几个月进行准备，投入大量的人力物力去做独立系统的线上压力评测。在这个过程中会遇到各种问题，比如压测的数据跟线上对比不够准确、差距太大，导致压测结果不具备参考价值；还有容量规划问题，当前的TiDB集群规模，是否能够支撑活动的大规模流量，工程师们可能只能依据往年经验和线上资源使用率给出评估量，而估计过大或者过小都会导致一些严重的后果。

为了解决以上痛点问题，我们提出了TiTravel解决方案，旨在实现对TiDB负载的录制与回放，让用户可以便捷地进行场景仿真和压测，更好地评估线上整个TiDB集群的性能和容量水平，保障业务稳定性。

## 项目设计

整个项目分为两部分：负载的录制与回放，以及可观测性的增强。

### 负载录制与回放

#### 录制逻辑

- 用户在 TiDB Dashboard 中按下“开始录制”的按钮后，TiDB Dashboard 发送请求给所有的 TiDB 实例。

- 在 TiDB 中增加逻辑：在 TiDB Dashboard 发来开始录制的请求之后，对 server 端收到的包都进行抓取，按照以下格式（录制id，实例，时间戳，包/SQL 语句，当前数据库）进行保存，保存到本地文件 (考虑到保存本地设涉及到 IO 限制，可以考虑 batch 发送)。

- 在 TiDB Dashboard 发来结束录制的请求之后，将保存的文件发给 TiDB Dashboard，Dashboard 根据每个文件中的时间戳记录，对所有的记录根据时间戳进行败者树排序，排列出一个总共的按顺序的记录，并保存在本地。

#### 回放逻辑

在 TiDB Dashboard 中选择录制文件按下“开始回放”的按钮后，TiDB Dashboard 会根据文件中的时间差，按顺序向指定的 TiDB 实例发送 sql 请求/包。若 SQL 语句时间戳同一秒 or 同一毫秒，则开多个 go routine 对其进行发送。（考虑到多是 IO 压力，可以开较多的 go routine）

在事务开始创建时，给事务写上 UUID 作为唯一标识：

- 在 TiDB 维护一个内存 map，在检测到事务 id 处于 map 中时，则将 sql 放入 map 中，直到检测到对应 id 的 commit，将对应 id 的 sql 全部取出，并组装为同一个包放入 channel 
- 在文件中新增一列表示事务id，如果不是处于事务中则为0，在 回放时检测到 sql 处于事务中时，放入 map 中，直到找到 commit，将对应的 所有 sql 放入 go routine 中运行。

#### 实现所需（7-9人天）

1. 修改 TiDB Dashboard 部分逻辑
2. 修改 TiDB 部分逻辑
3. 修改 PD 逻辑

#### 需要考虑的问题

1. 保存的文件较大，会增大 TiDB 网络传输压力 (实测：在按照 80 SQL/s，录制一小时标准下，以包保存会产生 70M 的文件，以 SQL 会产生 24M 文件)
2. 回放的逻辑，是否有更完美的实现？
3. 回放SQL的执行过程？dryrun or crud on 影子库？
4. 如何区分回放流量和普通流量？



